import asyncio
import logging
from datetime import datetime, time as dt_time
from typing import List
import random
from telegram import Bot
from telegram.error import TelegramError
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from apscheduler.triggers.interval import IntervalTrigger

# إعداد logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# إعدادات البوت
BOT_TOKEN = "8492798785:AAE3U_XrO3nz9HgEFh0RQk8gz2oIuINm8es"
CHANNEL_USERNAME = "@FazakerInNafaatAlZekra"

# الباقيات الصالحات - أذكار عامة
BAQIYAT_SALIHAT = [
    "أستغفر الله وأتوب إليه",
    "سبحان الله وبحمده، سبحان الله العظيم",
    "لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير",
    "لا حول ولا قوة إلا بالله العلي العظيم",
    "الله أكبر كبيراً، والحمد لله كثيراً، وسبحان الله بكرة وأصيلاً",
    "سبحان الله، والحمد لله، ولا إله إلا الله، والله أكبر",
    "اللهم صل وسلم وبارك على نبينا محمد وآله",
    "رب اغفر لي وتب علي إنك أنت التواب الرحيم",
    "اللهم إني أسألك العفو والعافية في الدنيا والآخرة",
    "لا إله إلا أنت سبحانك إني كنت من الظالمين",
    "اللهم إني أعوذ بك من الهم والحزن",
    "اللهم آتنا في الدنيا حسنة وفي الآخرة حسنة وقنا عذاب النار",
    "اللهم إنك عفو كريم تحب العفو فاعف عني",
    "ربنا لا تزغ قلوبنا بعد إذ هديتنا وهب لنا من لدنك رحمة إنك أنت الوهاب",
    "اللهم اغفر لي ولوالدي وللمؤمنين يوم يقوم الحساب",
    "اللهم إني أسألك الهدى والتقى والعفاف والغنى",
    "اللهم إني أسألك علماً نافعاً ورزقاً طيباً وعملاً متقبلاً",
    "اللهم أصلح لي ديني الذي هو عصمة أمري",
    "اللهم إني أسألك من الخير كله عاجله وآجله",
    "اللهم اهدني وسددني",
    "اللهم طهر قلبي من النفاق وعملي من الرياء",
    "اللهم اجعلني من التوابين واجعلني من المتطهرين",
    "اللهم إني أسألك الجنة وما قرب إليها من قول وعمل",
    "اللهم أعني على ذكرك وشكرك وحسن عبادتك",
]

# أذكار الصباح
MORNING_AZKAR = [
    "أصبحنا وأصبح الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير",
    "اللهم بك أصبحنا، وبك أمسينا، وبك نحيا، وبك نموت، وإليك النشور",
    "اللهم إني أسألك خير هذا اليوم: فتحه، ونصره، ونوره، وبركته، وهداه، وأعوذ بك من شر ما فيه وشر ما بعده",
    "رضيت بالله ربًا، وبالإسلام دينًا، وبمحمد صلى الله عليه وسلم نبيًا",
    "اللهم عافني في بدني، اللهم عافني في سمعي، اللهم عافني في بصري، لا إله إلا أنت",
    "اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت",
    "أعوذ بكلمات الله التامات من شر ما خلق",
    "اللهم إني أصبحت أشهدك وأشهد حملة عرشك وملائكتك وجميع خلقك أنك أنت الله لا إله إلا أنت وأن محمداً عبدك ورسولك",
    "اللهم ما أصبح بي من نعمة أو بأحد من خلقك فمنك وحدك لا شريك لك، فلك الحمد ولك الشكر",
    "يا حي يا قيوم برحمتك أستغيث، أصلح لي شأني كله ولا تكلني إلى نفسي طرفة عين",
    "أصبحنا على فطرة الإسلام، وعلى كلمة الإخلاص، وعلى دين نبينا محمد صلى الله عليه وسلم، وعلى ملة أبينا إبراهيم حنيفاً مسلماً وما كان من المشركين",
    "اللهم إني أسألك العافية في الدنيا والآخرة",
    "اللهم إني أسألك العفو والعافية في ديني ودنياي وأهلي ومالي",
    "اللهم استر عوراتي وآمن روعاتي",
    "اللهم احفظني من بين يدي ومن خلفي وعن يميني وعن شمالي ومن فوقي وأعوذ بعظمتك أن أغتال من تحتي",
    "اللهم فاطر السماوات والأرض، عالم الغيب والشهادة، رب كل شيء ومليكه، أشهد أن لا إله إلا أنت",
    "بسم الله الذي لا يضر مع اسمه شيء في الأرض ولا في السماء وهو السميع العليم",
    "اللهم إني أعوذ بك من الكفر والفقر، وأعوذ بك من عذاب القبر، لا إله إلا أنت",
]

# أذكار المساء
EVENING_AZKAR = [
    "أمسينا وأمسى الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير",
    "اللهم بك أمسينا، وبك أصبحنا، وبك نحيا، وبك نموت، وإليك المصير",
    "اللهم إني أسألك خير هذه الليلة: فتحها، ونصرها، ونورها، وبركتها، وهداها، وأعوذ بك من شر ما فيها وشر ما بعدها",
    "اللهم إني أعوذ بك من الهم والحزن، وأعوذ بك من العجز والكسل، وأعوذ بك من الجبن والبخل، وأعوذ بك من غلبة الدين وقهر الرجال",
    "أعوذ بكلمات الله التامات من شر ما خلق",
    "اللهم إنك عفو كريم تحب العفو فاعف عني",
    "اللهم أجرني من النار",
    "اللهم ما أمسى بي من نعمة أو بأحد من خلقك فمنك وحدك لا شريك لك، فلك الحمد ولك الشكر",
    "اللهم إني أمسيت أشهدك وأشهد حملة عرشك وملائكتك وجميع خلقك أنك أنت الله لا إله إلا أنت وأن محمداً عبدك ورسولك",
    "يا حي يا قيوم برحمتك أستغيث، أصلح لي شأني كله ولا تكلني إلى نفسي طرفة عين",
    "أمسينا على فطرة الإسلام، وعلى كلمة الإخلاص، وعلى دين نبينا محمد صلى الله عليه وسلم، وعلى ملة أبينا إبراهيم حنيفاً مسلماً وما كان من المشركين",
    "اللهم إني أسألك العافية في الدنيا والآخرة",
    "اللهم إني أسألك العفو والعافية في ديني ودنياي وأهلي ومالي",
    "اللهم استر عوراتي وآمن روعاتي",
    "اللهم احفظني من بين يدي ومن خلفي وعن يميني وعن شمالي ومن فوقي وأعوذ بعظمتك أن أغتال من تحتي",
    "اللهم فاطر السماوات والأرض، عالم الغيب والشهادة، رب كل شيء ومليكه، أشهد أن لا إله إلا أنت",
    "بسم الله الذي لا يضر مع اسمه شيء في الأرض ولا في السماء وهو السميع العليم",
    "رضيت بالله ربًا، وبالإسلام دينًا، وبمحمد صلى الله عليه وسلم نبيًا",
]


class ZikrBot:
    """بوت إرسال الأذكار للقنوات"""
    
    def __init__(self, token: str, channel: str):
        self.bot = Bot(token=token)
        self.channel = channel
        self.scheduler = AsyncIOScheduler()
        
    async def send_message(self, text: str, emoji: str = "📿") -> bool:
        """إرسال رسالة للقناة مع معالجة الأخطاء"""
        try:
            message = f"{emoji} {text}"
            await self.bot.send_message(chat_id=self.channel, text=message)
            logger.info(f"✅ تم إرسال: {text[:50]}...")
            return True
        except TelegramError as e:
            logger.error(f"❌ خطأ في الإرسال: {e}")
            return False
        except Exception as e:
            logger.error(f"❌ خطأ غير متوقع: {e}")
            return False
    
    async def send_random_zikr(self):
        """إرسال ذكر عشوائي من الباقيات الصالحات"""
        zikr = random.choice(BAQIYAT_SALIHAT)
        await self.send_message(zikr, "📿")
    
    async def send_morning_azkar(self):
        """إرسال أذكار الصباح"""
        zikr = random.choice(MORNING_AZKAR)
        text = f"🌅 أذكار الصباح\n━━━━━━━━━━━━━━━\n{zikr}"
        await self.send_message(text, "")
    
    async def send_evening_azkar(self):
        """إرسال أذكار المساء"""
        zikr = random.choice(EVENING_AZKAR)
        text = f"🌇 أذكار المساء\n━━━━━━━━━━━━━━━\n{zikr}"
        await self.send_message(text, "")
    
    def setup_jobs(self):
        """إعداد جدولة المهام"""
        # أذكار عامة كل 30 دقيقة
        self.scheduler.add_job(
            self.send_random_zikr,
            IntervalTrigger(minutes=30),
            id='general_zikr',
            name='أذكار عامة'
        )
        
        # أذكار الصباح الساعة 5 صباحًا
        self.scheduler.add_job(
            self.send_morning_azkar,
            CronTrigger(hour=5, minute=0),
            id='morning_azkar',
            name='أذكار الصباح'
        )
        
        # أذكار المساء الساعة 4 مساءً
        self.scheduler.add_job(
            self.send_evening_azkar,
            CronTrigger(hour=16, minute=0),
            id='evening_azkar',
            name='أذكار المساء'
        )
        
        logger.info("✅ تم إعداد جميع المهام المجدولة")
    
    async def start(self):
        """بدء البوت"""
        logger.info("🕌 بدأ بوت الباقيات الصالحات...")
        logger.info("📿 يرسل أذكار متنوعة حسب الوقت")
        logger.info("🌅 أذكار الصباح: 5:00 صباحًا")
        logger.info("🌇 أذكار المساء: 4:00 عصرًا")
        logger.info("🔄 أذكار عامة: كل 30 دقيقة")
        logger.info("🤲 هذا البوت صدقة جارية ونشر للخير")
        logger.info("=" * 60)
        
        # التحقق من اتصال البوت
        try:
            bot_info = await self.bot.get_me()
            logger.info(f"🤖 البوت متصل: @{bot_info.username}")
        except Exception as e:
            logger.error(f"❌ فشل الاتصال بالبوت: {e}")
            return
        
        # إعداد وبدء المهام المجدولة
        self.setup_jobs()
        self.scheduler.start()
        
        # إرسال ذكر فوري عند البدء
        await self.send_random_zikr()
        
        # إبقاء البوت شغال
        try:
            while True:
                await asyncio.sleep(300)  # كل 5 دقائق
                logger.info("🔄 البوت شغال... الحمد لله")
        except KeyboardInterrupt:
            logger.info("🛑 تم إيقاف البوت - جزاك الله خيرًا")
            self.scheduler.shutdown()


async def main():
    """الدالة الرئيسية"""
    bot = ZikrBot(token=BOT_TOKEN, channel=CHANNEL_USERNAME)
    await bot.start()


if __name__ == "__main__":
    asyncio.run(main())